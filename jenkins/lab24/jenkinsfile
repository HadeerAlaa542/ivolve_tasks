#!/usr/bin/env groovy
@Library('jenkins-shared-library')_

pipeline {
    agent {
        label 'slave1'  // Run the pipeline on Jenkins slave
    }

    environment {
        GITHUB_REPO_URL = 'https://github.com/HadeerAlaa542/ivolve_tasks/tree/main/jenkins/lab24/app3'
        DOCKER_REGISTRY = "hadeeralaa542"
        DOCKER_IMAGE = "app3"
        DOCKERHUB_CRED_ID = "dockerhub"
        K8S_CRED_ID = 'kube'
        DEPLOYMENT = 'deployment.yaml'
    }

    stages {
        stage('Clone Repository') {
            steps {
                script {
                    // Clone the current branch dynamically
                    git url: GITHUB_REPO_URL, branch: env.BRANCH_NAME    
                }
            }
        }

        stage('Manage Docker Image') {
            steps {
                script {
                    BuildandPushDockerimage(DOCKERHUB_CRED_ID, DOCKER_REGISTRY, DOCKER_IMAGE)
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    // Define namespaceMap inside script block
                    def namespaceMap = [
                        'main': 'main',
                        'stag': 'stag',
                        'dev': 'dev'
                    ]

                    def namespace = namespaceMap[env.BRANCH_NAME]
                    if (!namespace) {
                        error "Branch '${env.BRANCH_NAME}' is not mapped to any namespace. Deployment aborted!"
                    }
                    DeployOnKubernetes(K8S_CRED_ID, DOCKER_REGISTRY, DOCKER_IMAGE, DEPLOYMENT, namespace)
                }
            }
        }
    }

    post {
        success {
            script {
                def namespaceMap = [
                    'main': 'main',
                    'stag': 'stag',
                    'dev': 'dev'
                ]
                echo "Deployment successful to namespace: ${namespaceMap.get(env.BRANCH_NAME, 'dev')}"
            }
        }
        failure {
            echo "Build or deployment failed."
        }
    }
}
